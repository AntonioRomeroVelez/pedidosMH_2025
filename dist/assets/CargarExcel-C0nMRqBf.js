import{r as T,u as B}from"./xlsx-eYdzo_tC.js";import{E as L}from"./exceljs.min-msG-RCKZ.js";import{F as $}from"./FileSaver.min-nz5RSOTS.js";import{_ as G,m as J,n as U,r as m,o as z,a as H,b as n,d as l,q as W,e,j as p,f as g,t as r,h as I,k as q,F as A,i as F,s as K}from"./index-DJb3zC13.js";import{L as Q}from"./LoadingComponent-gzs1nsu1.js";const X={class:"cargar-excel container",style:{"margin-top":"60px"}},Y={class:"mb-4"},Z={class:"input-group"},ee={key:0,class:"form-text text-success mt-2"},te={key:0,class:"alert alert-info"},oe={class:"mb-0"},ae={class:"mb-4"},re={key:1},se={key:2},ne={key:0,class:"mt-3"},le={key:1,class:"table-responsive mt-4"},de={class:"table table-bordered table-sm formato-tabla"},ce={__name:"CargarExcel",setup(ie){const v=J(),N=U(),P=m(!1),d=m([]),b=m([]),i=m([]),y=m(""),C=m(0);z(()=>{const c=localStorage.getItem("ListaProductos");c&&(d.value=JSON.parse(c))});const _=c=>{P.value=!0;const t=c.target.files[0];if(!t){P.value=!1;return}y.value=t.name;const u=new FileReader;u.onload=o=>{try{const s=new Uint8Array(o.target.result),k=T(s,{type:"array"});b.value=[],i.value=[];let E=[];k.SheetNames.forEach((h,ue)=>{const R=k.Sheets[h];B.sheet_to_json(R).forEach((a,M)=>{const j={Codigo:a.CODIGO,ID:`id-${M}-${Math.random().toString(36).substr(2,5)}`,NombreProducto:a.NombreProducto??a.NOMBRE??"",Presentacion:a.Presentacion??a.PRESENTACION??"",PrincipioActivo:a.PrincipioActivo??a.PRINCIPIO_ACTIVO??"",PrecioFarmacia:parseFloat(a.PrecioFarmacia??a.P_FARMACIA??"")||0,PVP:parseFloat(a.PVP??"")||0,Promocion:a.Promocion??a.PROMOCION??"",Descuento:parseInt(a.Descuento??a.DESCUENTO??0)||parseFloat(a.Descuento??a.DESCUENTO??0)||0,Marca:a.Marca??a.MARCA??"",IVA:parseInt(a.IVA??0)||0};E.push(j)})});const w=d.value.length>0?[...d.value]:JSON.parse(localStorage.getItem("ListaProductos")||"[]"),O=new Set(w.map(h=>h.Codigo)),f=[],x=[];E.forEach(h=>{O.has(h.Codigo)?x.push(h):f.push(h)}),d.value=[...w,...f],i.value=x,C.value=f.length,x.length>0?v.warning(`‚ö†Ô∏è ${x.length} productos repetidos. Puedes exportarlos.`):v.success(`‚úÖ ${f.length} productos nuevos agregados.`)}catch(s){v.error("‚ùå Error al procesar el archivo."),console.error("Error al leer Excel:",s)}finally{P.value=!1}},u.readAsArrayBuffer(t)};async function S(){if(!i.value.length){v.info("No hay productos repetidos para exportar");return}const c=new L.Workbook,t=c.addWorksheet("Productos Repetidos");t.columns=[{header:"CODIGO",key:"Codigo",width:15},{header:"NombreProducto",key:"NombreProducto",width:40},{header:"Presentacion",key:"Presentacion",width:25},{header:"PrincipioActivo",key:"PrincipioActivo",width:30},{header:"PrecioFarmacia",key:"PrecioFarmacia",width:15},{header:"PVP",key:"PVP",width:12},{header:"Promocion",key:"Promocion",width:15},{header:"Descuento",key:"Descuento",width:12},{header:"Marca",key:"Marca",width:20},{header:"IVA",key:"IVA",width:10}],i.value.forEach(s=>t.addRow(s)),t.getRow(1).eachCell(s=>{s.font={bold:!0,color:{argb:"FFFFFFFF"}},s.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFB91D1D"}},s.alignment={vertical:"middle",horizontal:"center"}});const o=await c.xlsx.writeBuffer();$.saveAs(new Blob([o]),"productos_repetidos.xlsx"),v.success("üì¶ Archivo de productos repetidos exportado correctamente")}const V=c=>{const t=d.value[c];return b.value.some(u=>u.id===t.ID)},D=()=>{localStorage.setItem("ListaProductos",JSON.stringify(d.value)),v.success(`‚úÖ Se guardaron ${d.value.length} productos en memoria (sin borrar los anteriores).`),setTimeout(()=>{N.push("/Productos")},1e3)};return(c,t)=>{const u=H("RouterLink");return l(),n("div",X,[t[10]||(t[10]=W('<h2 data-v-f943349e>üì• Cargar productos desde Excel</h2><p data-v-f943349e>üìù El archivo debe tener las siguientes columnas:</p><div class="table-responsive container" data-v-f943349e><table class="table table-bordered formato-tabla" data-v-f943349e><thead data-v-f943349e><tr data-v-f943349e><th data-v-f943349e>CODIGO</th><th data-v-f943349e>NombreProducto</th><th data-v-f943349e>Presentacion</th><th data-v-f943349e>PrincipioActivo</th><th data-v-f943349e>PrecioFarmacia</th><th data-v-f943349e>PVP</th><th data-v-f943349e>Promocion</th><th data-v-f943349e>Descuento</th><th data-v-f943349e>Marca</th><th data-v-f943349e>IVA</th></tr></thead><tbody data-v-f943349e><tr data-v-f943349e><td data-v-f943349e>2343</td><td data-v-f943349e>Paracetamol 500mg</td><td data-v-f943349e>Caja x 10</td><td data-v-f943349e>Paracetamol</td><td data-v-f943349e>1.50</td><td data-v-f943349e>2.00</td><td data-v-f943349e>2x1</td><td data-v-f943349e>10</td><td data-v-f943349e>Genfar</td><td data-v-f943349e>15</td></tr></tbody></table></div>',3)),e("div",Y,[t[1]||(t[1]=e("label",{for:"excelInput",class:"form-label fw-semibold text-primary"}," üìÑ Cargar archivo Excel ",-1)),e("div",Z,[t[0]||(t[0]=e("label",{class:"input-group-text bg-success text-white",for:"excelInput",style:{cursor:"pointer"}},[e("i",{class:"bi bi-arrow-bar-up me-2"}),g(" Subir Excel ")],-1)),e("input",{type:"file",class:"form-control",id:"excelInput",onChange:_,accept:".xlsx, .xls"},null,32)]),y.value?(l(),n("div",ee," Archivo seleccionado: "+r(y.value),1)):p("",!0)]),d.value.length||i.value.length?(l(),n("div",te,[t[5]||(t[5]=e("strong",null,"üìä Resumen:",-1)),e("ul",oe,[e("li",null,[t[2]||(t[2]=g(" üü¢ Nuevos productos cargados: ",-1)),e("b",null,r(C.value),1)]),e("li",null,[t[3]||(t[3]=g(" üü° Productos repetidos detectados: ",-1)),e("b",null,r(i.value.length),1)]),e("li",null,[t[4]||(t[4]=g(" üì¶ Total actual en memoria: ",-1)),e("b",null,r(d.value.length),1)])])])):p("",!0),e("div",ae,[d.value.length?(l(),n("button",{key:0,onClick:D,class:"btn btn-success m-2"}," üíæ Guardar productos en memoria ")):p("",!0),i.value.length?(l(),n("button",{key:1,onClick:S,class:"btn btn-danger m-2"}," üì§ Exportar productos repetidos ")):p("",!0),I(u,{class:"btn btn-warning px-2 sm m-2",to:"/Productos"},{default:q(()=>[...t[6]||(t[6]=[g(" Cancelar ",-1)])]),_:1})]),P.value?(l(),n("div",re,[I(Q)])):(l(),n("div",se,[b.value.length?(l(),n("div",ne,[t[7]||(t[7]=e("h5",{class:"text-danger"},"‚ùå Errores detectados:",-1)),e("ul",null,[(l(!0),n(A,null,F(b.value,o=>(l(),n("li",{key:`${o.hoja}-${o.fila}`},[e("strong",null,"Hoja "+r(o.hoja)+", Fila "+r(o.fila)+":",1),g(" "+r(o.errores.join(", ")),1)]))),128))])])):p("",!0),d.value.length?(l(),n("div",le,[t[9]||(t[9]=e("h4",null,"üëÄ Vista previa de productos cargados",-1)),e("table",de,[t[8]||(t[8]=e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"Codigo"),e("th",null,"NombreProducto"),e("th",null,"Presentacion"),e("th",null,"PrincipioActivo"),e("th",null,"PrecioFarmacia"),e("th",null,"PVP"),e("th",null,"Promocion"),e("th",null,"Descuento"),e("th",null,"Marca"),e("th",null,"IVA")])],-1)),e("tbody",null,[(l(!0),n(A,null,F(d.value,(o,s)=>(l(),n("tr",{key:s,class:K({"table-danger":V(s)})},[e("td",null,r(s+1),1),e("td",null,r(o.Codigo),1),e("td",null,r(o.NombreProducto),1),e("td",null,r(o.Presentacion),1),e("td",null,r(o.PrincipioActivo),1),e("td",null,r(o.PrecioFarmacia),1),e("td",null,r(o.PVP),1),e("td",null,r(o.Promocion),1),e("td",null,r(o.Descuento),1),e("td",null,r(o.Marca),1),e("td",null,r(o.IVA),1)],2))),128))])])])):p("",!0)]))])}}},be=G(ce,[["__scopeId","data-v-f943349e"]]);export{be as default};
