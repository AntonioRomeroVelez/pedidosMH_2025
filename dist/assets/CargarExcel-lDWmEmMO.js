import{r as $,u as G}from"./xlsx-hAyDQTdp.js";import{E as z}from"./exceljs.min-BkkL2IEM.js";import{F as J}from"./FileSaver.min-BIesyKCk.js";import{_ as U,m as W,n as q,r as m,o as H,a as K,b as s,d as l,q as Q,e as t,j as b,g as p,t as o,h as I,k as X,F as N,i as S,s as Y}from"./index-C25DgxFL.js";import{L as Z}from"./LoadingComponent-jZqQ2A-n.js";const tt={class:"cargar-excel container",style:{"margin-top":"60px"}},et={class:"mb-4"},at={class:"input-group"},ot={key:0,class:"form-text text-success mt-2"},rt={key:0,class:"alert alert-info"},st={class:"mb-0"},lt={class:"mb-4"},nt={key:1},dt={key:2},it={key:0,class:"mt-3"},ct={key:1,class:"table-responsive mt-4"},ut={class:"table table-bordered table-sm formato-tabla"},ht={__name:"CargarExcel",setup(vt){const v=W(),V=q(),g=m(!1),n=m([]),P=m([]),c=m([]),y=m(""),C=m(0);H(()=>{const i=localStorage.getItem("ListaProductos");i&&(n.value=JSON.parse(i))});const O=i=>{g.value=!0;const e=i.target.files[0];if(!e){g.value=!1;return}y.value=e.name;const u=new FileReader;u.onload=a=>{try{const r=new Uint8Array(a.target.result),k=$(r,{type:"array"});P.value=[],c.value=[];let E=[];k.SheetNames.forEach(h=>{const L=k.Sheets[h];G.sheet_to_json(L).forEach(w=>{const d={};Object.keys(w).forEach(F=>{const B=F.normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toUpperCase();d[B]=w[F]});const A=d.CODIGO?.toString().trim()||"",T={ID:A||`id-${Math.random().toString(36).substr(2,5)}`,Codigo:A,Marca:d.MARCA.replace("MARCA","")||"",NombreProducto:d.NOMBRE||"",Presentacion:d.PRESENTACION||"",PrincipioActivo:d.PRINCIPIO_ACTIVO||"",PrecioFarmacia:parseFloat((d.P_FARMACIA||"0").toString().replace(",","."))||0,PVP:parseFloat((d.PVP||"0").toString().replace(",","."))||0,Promocion:d.PROMOCION||"",Descuento:parseFloat((d.DESCUENTO||"0").toString())||0,IVA:parseFloat((d.IVA||"0").toString().replace(",","."))||0};E.push(T)})});const _=n.value.length>0?[...n.value]:JSON.parse(localStorage.getItem("ListaProductos")||"[]"),j=new Set(_.map(h=>h.Codigo)),f=[],x=[];E.forEach(h=>{j.has(h.Codigo)?x.push(h):f.push(h)}),n.value=[..._,...f],c.value=x,C.value=f.length,x.length>0?v.warning(`‚ö†Ô∏è ${x.length} productos repetidos. Puedes exportarlos.`):v.success(`‚úÖ ${f.length} productos nuevos agregados.`)}catch(r){v.error("‚ùå Error al procesar el archivo."),console.error("Error al leer Excel:",r)}finally{g.value=!1}},u.readAsArrayBuffer(e)};async function D(){if(!c.value.length){v.info("No hay productos repetidos para exportar");return}const i=new z.Workbook,e=i.addWorksheet("Productos Repetidos");e.columns=[{header:"CODIGO",key:"Codigo",width:15},{header:"Marca",key:"Marca",width:20},{header:"NombreProducto",key:"NombreProducto",width:40},{header:"Presentacion",key:"Presentacion",width:25},{header:"PrincipioActivo",key:"PrincipioActivo",width:30},{header:"PrecioFarmacia",key:"PrecioFarmacia",width:15},{header:"PVP",key:"PVP",width:12},{header:"Promocion",key:"Promocion",width:15},{header:"Descuento",key:"Descuento",width:12},{header:"IVA",key:"IVA",width:10}],c.value.forEach(r=>e.addRow(r)),e.getRow(1).eachCell(r=>{r.font={bold:!0,color:{argb:"FFFFFFFF"}},r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFB91D1D"}},r.alignment={vertical:"middle",horizontal:"center"}});const a=await i.xlsx.writeBuffer();J.saveAs(new Blob([a]),"productos_repetidos.xlsx"),v.success("üì¶ Archivo de productos repetidos exportado correctamente")}const R=i=>{const e=n.value[i];return P.value.some(u=>u.id===e.ID)},M=()=>{localStorage.setItem("ListaProductos",JSON.stringify(n.value)),v.success(`‚úÖ Se guardaron ${n.value.length} productos en memoria (sin borrar los anteriores).`),setTimeout(()=>{V.push("/Productos")},1e3)};return(i,e)=>{const u=K("RouterLink");return l(),s("div",tt,[e[10]||(e[10]=Q('<h2 data-v-2091a3eb>üì• Cargar productos desde Excel</h2><p data-v-2091a3eb>üìù El archivo debe tener las siguientes columnas:</p><div class="table-responsive container" data-v-2091a3eb><table class="table table-bordered formato-tabla" data-v-2091a3eb><thead data-v-2091a3eb><tr data-v-2091a3eb><th data-v-2091a3eb>CODIGO</th><th data-v-2091a3eb>Marca</th><th data-v-2091a3eb>Nombre</th><th data-v-2091a3eb>Presentacion</th><th data-v-2091a3eb>Principio_Activo</th><th data-v-2091a3eb>P_Farmacia</th><th data-v-2091a3eb>PVP</th><th data-v-2091a3eb>Promocion</th><th data-v-2091a3eb>Descuento</th><th data-v-2091a3eb>IVA</th></tr></thead><tbody data-v-2091a3eb><tr data-v-2091a3eb><td data-v-2091a3eb>2343</td><td data-v-2091a3eb>Genfar</td><td data-v-2091a3eb>Paracetamol 500mg</td><td data-v-2091a3eb>Caja x 10</td><td data-v-2091a3eb>Paracetamol</td><td data-v-2091a3eb>1.50</td><td data-v-2091a3eb>2.00</td><td data-v-2091a3eb>2x1</td><td data-v-2091a3eb>10</td><td data-v-2091a3eb>15</td></tr></tbody></table></div>',3)),t("div",et,[e[1]||(e[1]=t("label",{for:"excelInput",class:"form-label fw-semibold text-primary"}," üìÑ Cargar archivo Excel ",-1)),t("div",at,[e[0]||(e[0]=t("label",{class:"input-group-text bg-success text-white",for:"excelInput",style:{cursor:"pointer"}},[t("i",{class:"bi bi-arrow-bar-up me-2"}),p(" Subir Excel ")],-1)),t("input",{type:"file",class:"form-control",id:"excelInput",onChange:O,accept:".xlsx, .xls"},null,32)]),y.value?(l(),s("div",ot," Archivo seleccionado: "+o(y.value),1)):b("",!0)]),n.value.length||c.value.length?(l(),s("div",rt,[e[5]||(e[5]=t("strong",null,"üìä Resumen:",-1)),t("ul",st,[t("li",null,[e[2]||(e[2]=p(" üü¢ Nuevos productos cargados: ",-1)),t("b",null,o(C.value),1)]),t("li",null,[e[3]||(e[3]=p(" üü° Productos repetidos detectados: ",-1)),t("b",null,o(c.value.length),1)]),t("li",null,[e[4]||(e[4]=p(" üì¶ Total actual en memoria: ",-1)),t("b",null,o(n.value.length),1)])])])):b("",!0),t("div",lt,[n.value.length?(l(),s("button",{key:0,onClick:M,class:"btn btn-success m-2"}," üíæ Guardar productos en memoria ")):b("",!0),c.value.length?(l(),s("button",{key:1,onClick:D,class:"btn btn-danger m-2"}," üì§ Exportar productos repetidos ")):b("",!0),I(u,{class:"btn btn-warning px-2 sm m-2",to:"/Productos"},{default:X(()=>[...e[6]||(e[6]=[p(" Cancelar ",-1)])]),_:1})]),g.value?(l(),s("div",nt,[I(Z)])):(l(),s("div",dt,[P.value.length?(l(),s("div",it,[e[7]||(e[7]=t("h5",{class:"text-danger"},"‚ùå Errores detectados:",-1)),t("ul",null,[(l(!0),s(N,null,S(P.value,a=>(l(),s("li",{key:`${a.hoja}-${a.fila}`},[t("strong",null,"Hoja "+o(a.hoja)+", Fila "+o(a.fila)+":",1),p(" "+o(a.errores.join(", ")),1)]))),128))])])):b("",!0),n.value.length?(l(),s("div",ct,[e[9]||(e[9]=t("h4",null,"üëÄ Vista previa de productos cargados",-1)),t("table",ut,[e[8]||(e[8]=t("thead",null,[t("tr",null,[t("th",null,"Codigo"),t("th",null,"#"),t("th",null,"Marca"),t("th",null,"Nombre_Producto"),t("th",null,"Presentacion"),t("th",null,"Principio_Activo"),t("th",null,"P_Farmacia"),t("th",null,"PVP"),t("th",null,"Promocion"),t("th",null,"Descuento"),t("th",null,"IVA")])],-1)),t("tbody",null,[(l(!0),s(N,null,S(n.value,(a,r)=>(l(),s("tr",{key:r,class:Y({"table-danger":R(r)})},[t("td",null,o(a.Codigo),1),t("td",null,o(r+1),1),t("td",null,o(a.Marca),1),t("td",null,o(a.NombreProducto),1),t("td",null,o(a.Presentacion),1),t("td",null,o(a.PrincipioActivo),1),t("td",null,o(a.PrecioFarmacia),1),t("td",null,o(a.PVP),1),t("td",null,o(a.Promocion),1),t("td",null,o(a.Descuento),1),t("td",null,o(a.IVA),1)],2))),128))])])])):b("",!0)]))])}}},xt=U(ht,[["__scopeId","data-v-2091a3eb"]]);export{xt as default};
