import{r as $,u as G}from"./xlsx-eYdzo_tC.js";import{E as z}from"./exceljs.min-Ba1ubJyC.js";import{F as J}from"./FileSaver.min-BpN325M1.js";import{_ as U,m as W,n as q,r as m,o as H,a as K,b as s,d as l,q as Q,e as t,j as p,f as g,t as a,h as N,k as X,F as S,i as _,s as Y}from"./index-CfIIgL4z.js";import{L as Z}from"./LoadingComponent-BpJ4Wihr.js";const tt={class:"cargar-excel container",style:{"margin-top":"60px"}},et={class:"mb-4"},ot={class:"input-group"},at={key:0,class:"form-text text-success mt-2"},rt={key:0,class:"alert alert-info"},st={class:"mb-0"},lt={class:"mb-4"},nt={key:1},dt={key:2},it={key:0,class:"mt-3"},ct={key:1,class:"table-responsive mt-4"},ut={class:"table table-bordered table-sm formato-tabla"},ht={__name:"CargarExcel",setup(vt){const v=W(),V=q(),b=m(!1),n=m([]),P=m([]),c=m([]),y=m(""),C=m(0);H(()=>{const i=localStorage.getItem("ListaProductos");i&&(n.value=JSON.parse(i))});const O=i=>{b.value=!0;const e=i.target.files[0];if(!e){b.value=!1;return}y.value=e.name;const u=new FileReader;u.onload=o=>{try{const r=new Uint8Array(o.target.result),k=$(r,{type:"array"});P.value=[],c.value=[];let E=[];k.SheetNames.forEach(h=>{const L=k.Sheets[h];G.sheet_to_json(L).forEach(F=>{const d={};Object.keys(F).forEach(I=>{const B=I.normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toUpperCase();d[B]=F[I]});const A=d.CODIGO?.toString().trim()||"",T={ID:A||`id-${Math.random().toString(36).substr(2,5)}`,Codigo:A,Marca:d.MARCA||"",NombreProducto:d.NOMBRE||"",Presentacion:d.PRESENTACION||"",PrincipioActivo:d.PRINCIPIO_ACTIVO||"",PrecioFarmacia:parseFloat((d.P_FARMACIA||"0").toString().replace(",","."))||0,PVP:parseFloat((d.PVP||"0").toString().replace(",","."))||0,Promocion:d.PROMOCION||"",Descuento:parseFloat((d.DESCUENTO||"0").toString())||0,IVA:parseFloat((d.IVA||"0").toString().replace(",","."))||0};E.push(T)})});const w=n.value.length>0?[...n.value]:JSON.parse(localStorage.getItem("ListaProductos")||"[]"),j=new Set(w.map(h=>h.Codigo)),f=[],x=[];E.forEach(h=>{j.has(h.Codigo)?x.push(h):f.push(h)}),n.value=[...w,...f],c.value=x,C.value=f.length,x.length>0?v.warning(`‚ö†Ô∏è ${x.length} productos repetidos. Puedes exportarlos.`):v.success(`‚úÖ ${f.length} productos nuevos agregados.`)}catch(r){v.error("‚ùå Error al procesar el archivo."),console.error("Error al leer Excel:",r)}finally{b.value=!1}},u.readAsArrayBuffer(e)};async function D(){if(!c.value.length){v.info("No hay productos repetidos para exportar");return}const i=new z.Workbook,e=i.addWorksheet("Productos Repetidos");e.columns=[{header:"CODIGO",key:"Codigo",width:15},{header:"NombreProducto",key:"NombreProducto",width:40},{header:"Presentacion",key:"Presentacion",width:25},{header:"PrincipioActivo",key:"PrincipioActivo",width:30},{header:"PrecioFarmacia",key:"PrecioFarmacia",width:15},{header:"PVP",key:"PVP",width:12},{header:"Promocion",key:"Promocion",width:15},{header:"Descuento",key:"Descuento",width:12},{header:"Marca",key:"Marca",width:20},{header:"IVA",key:"IVA",width:10}],c.value.forEach(r=>e.addRow(r)),e.getRow(1).eachCell(r=>{r.font={bold:!0,color:{argb:"FFFFFFFF"}},r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFB91D1D"}},r.alignment={vertical:"middle",horizontal:"center"}});const o=await i.xlsx.writeBuffer();J.saveAs(new Blob([o]),"productos_repetidos.xlsx"),v.success("üì¶ Archivo de productos repetidos exportado correctamente")}const R=i=>{const e=n.value[i];return P.value.some(u=>u.id===e.ID)},M=()=>{localStorage.setItem("ListaProductos",JSON.stringify(n.value)),v.success(`‚úÖ Se guardaron ${n.value.length} productos en memoria (sin borrar los anteriores).`),setTimeout(()=>{V.push("/Productos")},1e3)};return(i,e)=>{const u=K("RouterLink");return l(),s("div",tt,[e[10]||(e[10]=Q('<h2 data-v-ed310524>üì• Cargar productos desde Excel</h2><p data-v-ed310524>üìù El archivo debe tener las siguientes columnas:</p><div class="table-responsive container" data-v-ed310524><table class="table table-bordered formato-tabla" data-v-ed310524><thead data-v-ed310524><tr data-v-ed310524><th data-v-ed310524>CODIGO</th><th data-v-ed310524>NombreProducto</th><th data-v-ed310524>Presentacion</th><th data-v-ed310524>PrincipioActivo</th><th data-v-ed310524>PrecioFarmacia</th><th data-v-ed310524>PVP</th><th data-v-ed310524>Promocion</th><th data-v-ed310524>Descuento</th><th data-v-ed310524>Marca</th><th data-v-ed310524>IVA</th></tr></thead><tbody data-v-ed310524><tr data-v-ed310524><td data-v-ed310524>2343</td><td data-v-ed310524>Paracetamol 500mg</td><td data-v-ed310524>Caja x 10</td><td data-v-ed310524>Paracetamol</td><td data-v-ed310524>1.50</td><td data-v-ed310524>2.00</td><td data-v-ed310524>2x1</td><td data-v-ed310524>10</td><td data-v-ed310524>Genfar</td><td data-v-ed310524>15</td></tr></tbody></table></div>',3)),t("div",et,[e[1]||(e[1]=t("label",{for:"excelInput",class:"form-label fw-semibold text-primary"}," üìÑ Cargar archivo Excel ",-1)),t("div",ot,[e[0]||(e[0]=t("label",{class:"input-group-text bg-success text-white",for:"excelInput",style:{cursor:"pointer"}},[t("i",{class:"bi bi-arrow-bar-up me-2"}),g(" Subir Excel ")],-1)),t("input",{type:"file",class:"form-control",id:"excelInput",onChange:O,accept:".xlsx, .xls"},null,32)]),y.value?(l(),s("div",at," Archivo seleccionado: "+a(y.value),1)):p("",!0)]),n.value.length||c.value.length?(l(),s("div",rt,[e[5]||(e[5]=t("strong",null,"üìä Resumen:",-1)),t("ul",st,[t("li",null,[e[2]||(e[2]=g(" üü¢ Nuevos productos cargados: ",-1)),t("b",null,a(C.value),1)]),t("li",null,[e[3]||(e[3]=g(" üü° Productos repetidos detectados: ",-1)),t("b",null,a(c.value.length),1)]),t("li",null,[e[4]||(e[4]=g(" üì¶ Total actual en memoria: ",-1)),t("b",null,a(n.value.length),1)])])])):p("",!0),t("div",lt,[n.value.length?(l(),s("button",{key:0,onClick:M,class:"btn btn-success m-2"}," üíæ Guardar productos en memoria ")):p("",!0),c.value.length?(l(),s("button",{key:1,onClick:D,class:"btn btn-danger m-2"}," üì§ Exportar productos repetidos ")):p("",!0),N(u,{class:"btn btn-warning px-2 sm m-2",to:"/Productos"},{default:X(()=>[...e[6]||(e[6]=[g(" Cancelar ",-1)])]),_:1})]),b.value?(l(),s("div",nt,[N(Z)])):(l(),s("div",dt,[P.value.length?(l(),s("div",it,[e[7]||(e[7]=t("h5",{class:"text-danger"},"‚ùå Errores detectados:",-1)),t("ul",null,[(l(!0),s(S,null,_(P.value,o=>(l(),s("li",{key:`${o.hoja}-${o.fila}`},[t("strong",null,"Hoja "+a(o.hoja)+", Fila "+a(o.fila)+":",1),g(" "+a(o.errores.join(", ")),1)]))),128))])])):p("",!0),n.value.length?(l(),s("div",ct,[e[9]||(e[9]=t("h4",null,"üëÄ Vista previa de productos cargados",-1)),t("table",ut,[e[8]||(e[8]=t("thead",null,[t("tr",null,[t("th",null,"Codigo"),t("th",null,"#"),t("th",null,"NombreProducto"),t("th",null,"Presentacion"),t("th",null,"PrincipioActivo"),t("th",null,"PrecioFarmacia"),t("th",null,"PVP"),t("th",null,"Promocion"),t("th",null,"Descuento"),t("th",null,"Marca"),t("th",null,"IVA")])],-1)),t("tbody",null,[(l(!0),s(S,null,_(n.value,(o,r)=>(l(),s("tr",{key:r,class:Y({"table-danger":R(r)})},[t("td",null,a(o.Codigo),1),t("td",null,a(r+1),1),t("td",null,a(o.NombreProducto),1),t("td",null,a(o.Presentacion),1),t("td",null,a(o.PrincipioActivo),1),t("td",null,a(o.PrecioFarmacia),1),t("td",null,a(o.PVP),1),t("td",null,a(o.Promocion),1),t("td",null,a(o.Descuento),1),t("td",null,a(o.Marca),1),t("td",null,a(o.IVA),1)],2))),128))])])])):p("",!0)]))])}}},xt=U(ht,[["__scopeId","data-v-ed310524"]]);export{xt as default};
