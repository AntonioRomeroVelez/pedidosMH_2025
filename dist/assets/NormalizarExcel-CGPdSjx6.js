import{r as y,u as S}from"./xlsx-eYdzo_tC.js";import{E as T}from"./exceljs.min-msG-RCKZ.js";import{F as k}from"./FileSaver.min-nz5RSOTS.js";import{_ as B,r as D,b as E,d as _,e,j as U,f as G,t as c,F as z,i as j}from"./index-DJb3zC13.js";const L={class:"container py-4",style:{"margin-top":"60px"}},H={class:"card mb-4"},W={class:"card-body"},q={class:"row g-3 align-items-center"},J={class:"col-md-8"},$={class:"col-auto"},K=["disabled"],Q={key:0,class:"card"},X={class:"card-body"},Y={class:"card-title"},Z={class:"table-responsive",style:{"max-height":"400px",overflow:"auto"}},tt={class:"table table-sm table-bordered"},et={__name:"NormalizarExcel",setup(nt){const C=D([]);function g(i){const t=i.target.files[0];t&&M(t)}function M(i){const t=new FileReader;t.onload=n=>{const s=new Uint8Array(n.target.result),o=y(s,{type:"array"});let f=[];for(const O of o.SheetNames){const u=o.Sheets[O];if(!u||!u["!ref"])continue;const P=S.sheet_to_json(u,{header:1,defval:""});if(!P||!P.length)continue;let N=-1,m=null,A="";for(let d=0;d<P.length;d++){const r=P[d].map(l=>l==null?"":String(l).trim()),R=r.join(" ").toUpperCase();if(R.includes("NOMBRE")&&(R.includes("PVP")||R.includes("P_FARMACIA")||R.includes("PROMOCION"))||r.some(l=>/^COD/i.test(l))&&r.some(l=>/NOMBRE/i.test(l))){A=p(P,d),N=d,m=x(r);continue}if(m&&N>=0){if(r.every(a=>a==="")){m=null,N=-1,A="";continue}const I=r.join(" ").toUpperCase();if(I.includes("NOMBRE")&&(I.includes("PVP")||I.includes("P_FARMACIA")||I.includes("PROMOCION"))){A=p(P,d),N=d,m=x(r);continue}const h=F(r,m,A);h&&h.NOMBRE&&f.push(h)}}}C.value=f},t.readAsArrayBuffer(i)}function p(i,t){for(let n=t-1;n>=Math.max(0,t-8);n--){const s=i[n];if(!s)continue;const o=(s[1]||"").toString().trim(),f=(s[0]||"").toString().trim(),O=o||f;if(O){const u=O.toString().toUpperCase();if(u.length>2&&!/COD|NOMBRE|PVP|P_FARMACIA|PRESENTACION/i.test(u))return O}}return""}function x(i){const t={};for(let n=0;n<i.length;n++){const o=(i[n]||"").toString().trim().toUpperCase();if(/NOMBRE/.test(o)||o==="NOMBRE COMERCIAL"||o.includes("NOMBRE")){t.idxNombre=n;continue}if(/PRESENTACIÓN/i.test(o)||o==="PRESENTACION"){t.idxPresent=n;continue}if(/PRINCIPIO ACTIVO/i.test(o)||o.includes("PRINCIPIO ACTIVO")){t.idxPrin=n;continue}if(/P_FARMACIA/i.test(o)||o.includes("P_FARMACIA")){t.idxPfarm=n;continue}if(/PVP/i.test(o)||o.includes("PVP")||o==="PVP"){t.idxPvp=n;continue}if(/PROMOCION/i.test(o)){t.idxPromo=n;continue}if(/DESCUENTO/i.test(o)){t.idxDesc=n;continue}if(/IVA/i.test(o)){t.idxIva=n;continue}if(/COD|CODIGO/i.test(o)){t.idxCod=n;continue}}return t}function F(i,t,n){const s=a=>typeof a=="number"?i[a]===void 0?"":String(i[a]).trim():"",o=s(t.idxNombre)||"";if(!o)return null;const f=s(t.idxCod)||"",O=s(t.idxPresent)||"",u=s(t.idxPrin)||"",P=s(t.idxPfarm)||"",N=s(t.idxPvp)||"",m=s(t.idxPromo)||"",A=s(t.idxDesc)||"",d=s(t.idxIva)||"",r=a=>{if(!a&&a!==0)return null;const V=String(a).replace(",",".").replace(/[^0-9.\-]/g,""),w=parseFloat(V);return isNaN(w)?null:w},R=r(P)??0,b=r(N)??0;let l="";if(A){const a=r(A);l=a!==null?`${Number(a)*100}%`:String(A).trim()}else l="";const I=r(d),h=I===null?0:I+" %";return{CODIGO:f,MARCA:n||"",NOMBRE:o,PRESENTACION:O,PRINCIPIO_ACTIVO:u,P_FARMACIA:R,PVP:b,PROMOCION:m,DESCUENTO:l,IVA:h}}async function v(){if(!C.value.length)return;const i=new T.Workbook,t=i.addWorksheet("Productos");t.columns=[{header:"CÓDIGO",key:"CODIGO",width:30},{header:"MARCA",key:"MARCA",width:30},{header:"NOMBRE",key:"NOMBRE",width:40},{header:"PRESENTACION",key:"PRESENTACION",width:20},{header:"PRINCIPIO_ACTIVO",key:"PRINCIPIO_ACTIVO",width:30},{header:"P_FARMACIA",key:"P_FARMACIA",width:12},{header:"PVP",key:"PVP",width:12},{header:"PROMOCION",key:"PROMOCION",width:18},{header:"DESCUENTO",key:"DESCUENTO",width:12},{header:"IVA",key:"IVA",width:8}],t.getRow(1).eachCell(o=>{o.font={bold:!0,color:{argb:"FFFFFFFF"}},o.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF1F4E78"}},o.alignment={vertical:"middle",horizontal:"center"}}),C.value.forEach(o=>{t.addRow(o)}),t.getColumn("P_FARMACIA").numFmt="#,##0.00",t.getColumn("PVP").numFmt="#,##0.00",t.getColumn("IVA").numFmt="0.00";const s=await i.xlsx.writeBuffer();k.saveAs(new Blob([s]),"productos_formateados.xlsx")}return(i,t)=>(_(),E("div",L,[t[3]||(t[3]=e("h2",{class:"text-center mb-4"}," Formato productos - Extraer MARCA y normalizar ",-1)),e("div",H,[e("div",W,[e("div",q,[e("div",J,[e("input",{type:"file",accept:".xlsx,.xls",class:"form-control",onChange:g},null,32)]),e("div",$,[e("button",{class:"btn btn-primary",disabled:!C.value.length,onClick:v},[...t[0]||(t[0]=[e("i",{class:"bi bi-file-earmark-arrow-down"},null,-1),G(" Exportar formateado ",-1)])],8,K)]),t[1]||(t[1]=e("div",{class:"col-12"},[e("small",{class:"text-muted"},"Estructura esperada:CODIGO, NOMBRE COMERCIAL, PRESENTACION, PRINCIPIO, ACTIVO P_FARMACIA, PVP, PROMOCION, DESCUENTO, IVA. El componente detecta bloques por encabezado.")],-1))])])]),C.value.length?(_(),E("div",Q,[e("div",X,[e("h5",Y," Vista previa ("+c(C.value.length)+" filas) ",1),e("div",Z,[e("table",tt,[t[2]||(t[2]=e("thead",{class:"table-light"},[e("tr",null,[e("th",null,"CODIGO"),e("th",null,"NombreProducto"),e("th",null,"Presentacion"),e("th",null,"PrincipioActivo"),e("th",null,"PrecioFarmacia"),e("th",null,"PVP"),e("th",null,"Promocion"),e("th",null,"Descuento"),e("th",null,"Marca"),e("th",null,"IVA")])],-1)),e("tbody",null,[(_(!0),E(z,null,j(C.value,(n,s)=>(_(),E("tr",{key:s},[e("td",null,c(n.CODIGO),1),e("td",null,c(n.NOMBRE),1),e("td",null,c(n.PRESENTACION),1),e("td",null,c(n.PRINCIPIO_ACTIVO),1),e("td",null,c(n.P_FARMACIA),1),e("td",null,c(n.PVP),1),e("td",null,c(n.PROMOCION),1),e("td",null,c(n.DESCUENTO),1),e("td",null,c(n.MARCA),1),e("td",null,c(n.IVA),1)]))),128))])])])])])):U("",!0)]))}},lt=B(et,[["__scopeId","data-v-3b608c0a"]]);export{lt as default};
