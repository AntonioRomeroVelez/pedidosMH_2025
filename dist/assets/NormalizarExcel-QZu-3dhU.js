import{r as V,u as S}from"./xlsx-hAyDQTdp.js";import{E as k}from"./exceljs.min-BbdNrdus.js";import{F as D}from"./FileSaver.min-ChHjgRQ7.js";import{_ as T,r as F,b as N,d as R,e,i as B,k as U,t as l,F as G,h as z}from"./index-BU21frmg.js";const j={class:"container py-4"},L={class:"card mb-4 shadow-sm"},H={class:"card-body"},W={class:"row g-3 align-items-center"},$={class:"col-md-8"},J={class:"col-auto"},Q=["disabled"],q={key:0,class:"card shadow-sm"},K={class:"card-body"},X={class:"card-title"},Y={class:"table-responsive",style:{"max-height":"400px",overflow:"auto"}},Z={class:"table table-sm table-bordered align-middle"},tt={__name:"NormalizarExcel",setup(et){const P=F([]),_=F("");function M(s){const t=parseFloat(s);return isNaN(t)?"":t.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}function b(s){const t=s.target.files[0];t&&(_.value=t.name.replace(/\.[^/.]+$/,""),g(t))}function g(s){const t=new FileReader;t.onload=o=>{const r=new Uint8Array(o.target.result),d=V(r,{type:"array"});let n=[];for(const i of d.SheetNames){const a=d.Sheets[i];if(!a||!a["!ref"])continue;const C=S.sheet_to_json(a,{header:1,defval:""});if(!C.length)continue;let m=-1,O=null,I="";for(let A=0;A<C.length;A++){const c=C[A].map(u=>u==null?"":String(u).trim()),f=c.join(" ").toUpperCase();if(f.includes("NOMBRE")&&(f.includes("PVP")||f.includes("P_FARMACIA")||f.includes("PROMOCION"))||c.some(u=>/^COD/i.test(u))&&c.some(u=>/NOMBRE/i.test(u))){I=p(C,A),m=A,O=x(c);continue}if(O&&m>=0){if(c.every(y=>y==="")){O=null,m=-1,I="";continue}const h=c.join(" ").toUpperCase();if(h.includes("NOMBRE")&&(h.includes("PVP")||h.includes("P_FARMACIA")||h.includes("PROMOCION"))){I=p(C,A),m=A,O=x(c);continue}const E=w(c,O,I);E&&E.NOMBRE&&n.push(E)}}}n.sort((i,a)=>i.MARCA.localeCompare(a.MARCA)),P.value=n},t.readAsArrayBuffer(s)}function p(s,t){for(let o=t-1;o>=Math.max(0,t-8);o--){const r=s[o];if(!r)continue;const d=(r[1]||"").toString().trim(),n=(r[0]||"").toString().trim(),i=d||n;if(i){const a=i.toUpperCase();if(a.length>2&&!/COD|NOMBRE|PVP|P_FARMACIA|PRESENTACION/i.test(a))return i}}return""}function x(s){const t={};for(let o=0;o<s.length;o++){const r=(s[o]||"").toUpperCase();/COD|CODIGO/.test(r)&&(t.idxCod=o),/NOMBRE/.test(r)&&(t.idxNombre=o),/PRESENT/.test(r)&&(t.idxPresent=o),/PRINCIPIO/.test(r)&&(t.idxPrin=o),/P_FARMACIA|P\.Q\.1/.test(r)&&(t.idxPfarm=o),/PVP|P\.V\.P/.test(r)&&(t.idxPvp=o),/PROMOCION/.test(r)&&(t.idxPromo=o),/DESCUENTO/.test(r)&&(t.idxDesc=o),/IVA/.test(r)&&(t.idxIva=o)}return t}function w(s,t,o){const r=i=>typeof i=="number"?String(s[i]||"").trim():"",d=i=>{if(!i)return 0;const a=parseFloat(String(i).replace(",",".").replace(/[^0-9.\-]/g,""));return isNaN(a)?0:a};return r(t.idxNombre)?{CODIGO:r(t.idxCod),MARCA:o.trim(),NOMBRE:r(t.idxNombre).trim(),PRESENTACION:r(t.idxPresent).trim(),PRINCIPIO_ACTIVO:r(t.idxPrin).trim(),P_FARMACIA:d(r(t.idxPfarm)).toFixed(2),PVP:d(r(t.idxPvp)).toFixed(2),PROMOCION:r(t.idxPromo),DESCUENTO:r(t.idxDesc)*100,IVA:r(t.idxIva)||"0"}:null}async function v(){if(!P.value.length)return;const s=new k.Workbook,t=s.addWorksheet("Productos");t.columns=[{header:"CODIGO",key:"CODIGO",width:15},{header:"MARCA",key:"MARCA",width:25},{header:"NOMBRE",key:"NOMBRE",width:40},{header:"PRESENTACION",key:"PRESENTACION",width:25},{header:"PRINCIPIO_ACTIVO",key:"PRINCIPIO_ACTIVO",width:25},{header:"P_FARMACIA",key:"P_FARMACIA",width:15},{header:"PVP",key:"PVP",width:15},{header:"PROMOCION",key:"PROMOCION",width:20},{header:"DESCUENTO",key:"DESCUENTO",width:15},{header:"IVA",key:"IVA",width:10}],t.getRow(1).eachCell(n=>{n.font={bold:!0,color:{argb:"FFFFFFFF"}},n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF1F4E78"}},n.alignment={vertical:"middle",horizontal:"center"}}),P.value.forEach(n=>{t.addRow({...n,P_FARMACIA:parseFloat(n.P_FARMACIA),PVP:parseFloat(n.PVP)})}),t.getColumn("P_FARMACIA").numFmt="#,##0.00",t.getColumn("PVP").numFmt="#,##0.00";const r=await s.xlsx.writeBuffer(),d=`${_.value||"productos"}_formateado.xlsx`;D.saveAs(new Blob([r]),d)}return(s,t)=>(R(),N("div",j,[t[3]||(t[3]=e("h2",{class:"text-center mb-4"}," ðŸ§¾ Formato productos - Extraer MARCA y normalizar ",-1)),e("div",L,[e("div",H,[e("div",W,[e("div",$,[e("input",{type:"file",accept:".xlsx,.xls",class:"form-control",onChange:b},null,32)]),e("div",J,[e("button",{class:"btn btn-primary",disabled:!P.value.length,onClick:v},[...t[0]||(t[0]=[e("i",{class:"bi bi-file-earmark-arrow-down"},null,-1),U(" Exportar formateado ",-1)])],8,Q)]),t[1]||(t[1]=e("div",{class:"col-12"},[e("small",{class:"text-muted"}," Estructura esperada: CODIGO, NOMBRE COMERCIAL, PRESENTACION, PRINCIPIO ACTIVO, P_FARMACIA, PVP, PROMOCION, DESCUENTO, IVA. ")],-1))])])]),P.value.length?(R(),N("div",q,[e("div",K,[e("h5",X," Vista previa ("+l(P.value.length)+" productos) ",1),e("div",Y,[e("table",Z,[t[2]||(t[2]=e("thead",{class:"table-light"},[e("tr",null,[e("th",null,"CODIGO"),e("th",null,"MARCA"),e("th",null,"NOMBRE"),e("th",null,"PRESENTACION"),e("th",null,"PRINCIPIO_ACTIVO"),e("th",null,"P_FARMACIA"),e("th",null,"PVP"),e("th",null,"PROMOCION"),e("th",null,"DESCUENTO"),e("th",null,"IVA")])],-1)),e("tbody",null,[(R(!0),N(G,null,z(P.value,(o,r)=>(R(),N("tr",{key:r},[e("td",null,l(o.CODIGO),1),e("td",null,l(o.MARCA),1),e("td",null,l(o.NOMBRE),1),e("td",null,l(o.PRESENTACION),1),e("td",null,l(o.PRINCIPIO_ACTIVO),1),e("td",null,l(M(o.P_FARMACIA)),1),e("td",null,l(M(o.PVP)),1),e("td",null,l(o.PROMOCION),1),e("td",null,l(o.DESCUENTO),1),e("td",null,l(o.IVA),1)]))),128))])])])])])):B("",!0)]))}},at=T(tt,[["__scopeId","data-v-40795b6f"]]);export{at as default};
