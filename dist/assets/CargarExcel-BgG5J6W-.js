import{_ as G,m as U,n as J,r as p,c as W,o as q,a as H,b as r,d as s,q as K,e as t,j as h,g as f,t as a,h as I,k as Q,F as V,i as M,w as O,v as X,s as Y,x as Z}from"./index-Bg408plw.js";import{r as tt,u as et}from"./xlsx-hAyDQTdp.js";import{E as ot}from"./exceljs.min-CWbKu3wC.js";import{F as at}from"./FileSaver.min-BKMsn9Ug.js";import{L as rt}from"./LoadingComponent-DRmx4X3f.js";const st={class:"cargar-excel container",style:{"margin-top":"60px"}},lt={class:"mb-4"},it={class:"input-group"},nt={key:0,class:"form-text text-success mt-2"},dt={key:0,class:"alert alert-info"},ct={class:"mb-0"},ut={class:"mb-4"},pt={key:1},mt={key:2},vt={key:0,class:"mt-3"},ht={key:1,class:"vista-previa mt-4"},ft={class:"d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 gap-3"},xt={class:"d-flex flex-wrap gap-2 justify-content-center"},gt={class:"table-responsive shadow-sm rounded-4 border position-relative",style:{"max-height":"70vh","overflow-y":"auto"}},bt={class:"table table-hover align-middle text-center table-striped",style:{"min-width":"950px","word-wrap":"break-word","table-layout":"fixed"}},yt={class:"text-break"},Pt={class:"text-break"},wt={class:"text-break"},_t={class:"text-break"},kt={class:"text-break"},Ct={class:"text-break"},St={__name:"CargarExcel",setup(Ft){const m=U(),D=J(),g=p(!1),c=p([]),w=p([]),v=p([]),_=p(""),R=p(0),b=p(!1),k=p(""),y=p("todos"),j=W(()=>{const i=k.value.trim().toLowerCase();return c.value.filter(e=>y.value==="repetidos"&&!e.duplicado||y.value==="validos"&&e.duplicado?!1:i?[e.NombreProducto,e.Marca,e.Presentacion,e.PrincipioActivo].map(u=>(u||"").toString().toLowerCase()).some(u=>u.includes(i)):!0)});q(()=>{const i=localStorage.getItem("ListaProductos");i&&(c.value=JSON.parse(i))});const T=i=>{g.value=!0;const e=i.target.files[0];if(!e){g.value=!1;return}_.value=e.name;const u=new FileReader;u.onload=o=>{try{const l=new Uint8Array(o.target.result),F=tt(l,{type:"array"});w.value=[],v.value=[],b.value=!1;let C=[];F.SheetNames.forEach(d=>{const x=F.Sheets[d];et.sheet_to_json(x).forEach(N=>{const n={};Object.keys(N).forEach(A=>{const z=A.normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toUpperCase();n[z]=N[A]});const E=n.CODIGO?.toString().trim()||"",$={ID:E||`id-${Math.random().toString(36).substr(2,5)}`,Codigo:E,Marca:n.MARCA?.toString().trim()||"",NombreProducto:n.NOMBRE?.toString().trim()||"",Presentacion:n.PRESENTACION?.toString().trim()||"",PrincipioActivo:n.PRINCIPIO_ACTIVO?.toString().trim()||"",PrecioFarmacia:(parseFloat((n.P_FARMACIA||"0").toString().replace(",","."))||0).toFixed(2),PVP:(parseFloat((n.PVP||"0").toString().replace(",","."))||0).toFixed(2),Promocion:n.PROMOCION||"",Descuento:parseFloat((n.DESCUENTO||"0").toString())||0,IVA:parseFloat((n.IVA||"0").toString().replace(",","."))||0,duplicado:!1};C.push($)})});const P=d=>(d||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"").toLowerCase(),S=new Map;C.forEach(d=>{const x=`${P(d.Marca)}|${P(d.NombreProducto)}|${P(d.Presentacion)}|${P(d.PrincipioActivo)}`;S.has(x)?(d.duplicado=!0,S.get(x).duplicado=!0,b.value=!0):S.set(x,d)}),c.value=C,b.value?m.error("‚ö†Ô∏è Se detectaron productos duplicados en el archivo. Revisa los resaltados en rojo."):m.success("‚úÖ Archivo cargado correctamente, sin duplicados internos.")}catch(l){m.error("‚ùå Error al procesar el archivo."),console.error("Error al leer Excel:",l)}finally{g.value=!1}},u.readAsArrayBuffer(e)},L=()=>{if(b.value){m.error("‚ùå No se puede guardar. Elimina los productos duplicados primero.");return}localStorage.setItem("ListaProductos",JSON.stringify(c.value)),m.success(`‚úÖ Se guardaron ${c.value.length} productos en memoria correctamente.`),setTimeout(()=>{D.push("/Productos")},1e3)};async function B(){if(!v.value.length){m.info("No hay productos repetidos para exportar");return}const i=new ot.Workbook,e=i.addWorksheet("Productos Repetidos");e.columns=[{header:"CODIGO",key:"Codigo",width:15},{header:"Marca",key:"Marca",width:20},{header:"NombreProducto",key:"NombreProducto",width:40},{header:"Presentacion",key:"Presentacion",width:25},{header:"PrincipioActivo",key:"PrincipioActivo",width:30}],v.value.forEach(l=>e.addRow(l)),e.getRow(1).eachCell(l=>{l.font={bold:!0,color:{argb:"FFFFFFFF"}},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFB91D1D"}},l.alignment={vertical:"middle",horizontal:"center"}});const o=await i.xlsx.writeBuffer();at.saveAs(new Blob([o]),"productos_repetidos.xlsx"),m.success("üì¶ Archivo de productos repetidos exportado correctamente")}return(i,e)=>{const u=H("RouterLink");return s(),r("div",st,[e[13]||(e[13]=K('<h2 data-v-147f4419>üì• Cargar productos desde Excel</h2><p data-v-147f4419>üìù El archivo debe tener las siguientes columnas:</p><div class="table-responsive container" data-v-147f4419><table class="table table-bordered formato-tabla" data-v-147f4419><thead data-v-147f4419><tr data-v-147f4419><th data-v-147f4419>CODIGO</th><th data-v-147f4419>Marca</th><th data-v-147f4419>Nombre</th><th data-v-147f4419>Presentacion</th><th data-v-147f4419>Principio_Activo</th><th data-v-147f4419>P_Farmacia</th><th data-v-147f4419>PVP</th><th data-v-147f4419>Promocion</th><th data-v-147f4419>Descuento</th><th data-v-147f4419>IVA</th></tr></thead><tbody data-v-147f4419><tr data-v-147f4419><td data-v-147f4419>2343</td><td data-v-147f4419>Genfar</td><td data-v-147f4419>Paracetamol 500mg</td><td data-v-147f4419>Caja x 10</td><td data-v-147f4419>Paracetamol</td><td data-v-147f4419>1.50</td><td data-v-147f4419>2.00</td><td data-v-147f4419>2x1</td><td data-v-147f4419>10</td><td data-v-147f4419>15</td></tr></tbody></table></div>',3)),t("div",lt,[e[3]||(e[3]=t("label",{for:"excelInput",class:"form-label fw-semibold text-primary"}," üìÑ Cargar archivo Excel ",-1)),t("div",it,[e[2]||(e[2]=t("label",{class:"input-group-text bg-success text-white",for:"excelInput",style:{cursor:"pointer"}},[t("i",{class:"bi bi-arrow-bar-up me-2"}),f(" Subir Excel ")],-1)),t("input",{type:"file",class:"form-control",id:"excelInput",onChange:T,accept:".xlsx, .xls"},null,32)]),_.value?(s(),r("div",nt," Archivo seleccionado: "+a(_.value),1)):h("",!0)]),c.value.length||v.value.length?(s(),r("div",dt,[e[7]||(e[7]=t("strong",null,"üìä Resumen:",-1)),t("ul",ct,[t("li",null,[e[4]||(e[4]=f(" üü¢ Nuevos productos cargados: ",-1)),t("b",null,a(R.value),1)]),t("li",null,[e[5]||(e[5]=f(" üü° Productos repetidos detectados: ",-1)),t("b",null,a(v.value.length),1)]),t("li",null,[e[6]||(e[6]=f(" üì¶ Total actual en memoria: ",-1)),t("b",null,a(c.value.length),1)])])])):h("",!0),t("div",ut,[c.value.length?(s(),r("button",{key:0,onClick:L,class:"btn btn-success m-2"}," üíæ Guardar productos en memoria ")):h("",!0),v.value.length?(s(),r("button",{key:1,onClick:B,class:"btn btn-danger m-2"}," üì§ Exportar productos repetidos ")):h("",!0),I(u,{class:"btn btn-warning px-2 sm m-2",to:"/Productos"},{default:Q(()=>[...e[8]||(e[8]=[f(" Cancelar ",-1)])]),_:1})]),g.value?(s(),r("div",pt,[I(rt)])):(s(),r("div",mt,[w.value.length?(s(),r("div",vt,[e[9]||(e[9]=t("h5",{class:"text-danger"},"‚ùå Errores detectados:",-1)),t("ul",null,[(s(!0),r(V,null,M(w.value,o=>(s(),r("li",{key:`${o.hoja}-${o.fila}`},[t("strong",null,"Hoja "+a(o.hoja)+", Fila "+a(o.fila)+":",1),f(" "+a(o.errores.join(", ")),1)]))),128))])])):h("",!0),c.value.length?(s(),r("div",ht,[t("div",ft,[e[11]||(e[11]=t("h4",{class:"fw-bold text-primary mb-0"}," üëÄ Vista previa de productos cargados ",-1)),t("div",xt,[O(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>k.value=o),type:"text",class:"form-control",placeholder:"üîç Buscar por nombre, marca, presentaci√≥n o principio activo...",style:{"max-width":"300px"}},null,512),[[X,k.value]]),O(t("select",{"onUpdate:modelValue":e[1]||(e[1]=o=>y.value=o),class:"form-select",style:{"max-width":"220px"}},[...e[10]||(e[10]=[t("option",{value:"todos"},"Mostrar todos",-1),t("option",{value:"repetidos"},"Solo repetidos",-1),t("option",{value:"validos"},"Solo v√°lidos",-1)])],512),[[Y,y.value]])])]),t("div",gt,[t("table",bt,[e[12]||(e[12]=t("thead",{class:"table-primary sticky-header"},[t("tr",null,[t("th",{scope:"col",style:{"min-width":"40px"}},"C√≥digo"),t("th",{scope:"col",style:{width:"20px"}},"#"),t("th",{scope:"col",style:{"min-width":"140px"}},"Marca"),t("th",{scope:"col",style:{"min-width":"200px"}},"Nombre Producto"),t("th",{scope:"col",style:{"min-width":"140px"}},"Presentaci√≥n"),t("th",{scope:"col",style:{"min-width":"160px"}},"Principio Activo"),t("th",{scope:"col",style:{"min-width":"100px"}},"P. Farmacia"),t("th",{scope:"col",style:{"min-width":"90px"}},"PVP"),t("th",{scope:"col",style:{"min-width":"120px"}},"Promoci√≥n"),t("th",{scope:"col",style:{"min-width":"120px"}},"Descuento"),t("th",{scope:"col",style:{"min-width":"70px"}},"IVA")])],-1)),t("tbody",null,[(s(!0),r(V,null,M(j.value,(o,l)=>(s(),r("tr",{key:l,class:Z({"table-danger":o.duplicado})},[t("td",yt,a(o.Codigo),1),t("td",null,a(l+1),1),t("td",Pt,a(o.Marca),1),t("td",wt,a(o.NombreProducto),1),t("td",_t,a(o.Presentacion),1),t("td",kt,a(o.PrincipioActivo),1),t("td",null,a(o.PrecioFarmacia),1),t("td",null,a(o.PVP),1),t("td",Ct,a(o.Promocion),1),t("td",null,a(o.Descuento),1),t("td",null,a(o.IVA),1)],2))),128))])])])])):h("",!0)]))])}}},Ot=G(St,[["__scopeId","data-v-147f4419"]]);export{Ot as default};
